<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>        
		<!-- Load d3.js -->
		<script src="https://d3js.org/d3.v6.js"></script>
		<title>Ultimate Simulation</title>
    </head>
<body>



<nav class="navbar navbar-expand-sm fixed-top bg-dark" >
    <div class="container-fluid">
        
        <ul class="navbar-nav">
            <li class="nav-item"><a href="#about" class="nav-link">About</a></li>
            <li class="nav-item"><a href="#turnover" class="nav-link">Turnover Analysis</a></li>
        </ul>
        
    </div>
</nav>

<div class="jumbotron text-center">

    <div id="about" class="container-fluid">
        <div class="row">
          <div class="col-sm-12">
            <h2>About</h2><br>
            <h4>This page simulates games of ultimate based on your assumptions.</h4><br>
            <p>Team A starts on offence. 
               Each team has a fixed chance of turning it over, if they don't turn it over they score.  
               Whenever a team scores they use their defensive line on the next point and the other team uses their offensive line. 
               The exception is when half time is reached, in which case Team B starts on offence with their offensive line and Team A uses their defensive line. 
               
            </p>
            <br>
          </div>
        </div>
    </div>
    <div id="estimate" class="container-fluid">
		<div class="row" >
		Estimate turnover likelihood, just enter the score and turnovers for both teams. 
		
		</div>
	</div>
    <div id="turnover" class="container-fluid">       
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="score_max_slider">Maximum Score</label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="1" max="15" value="15" id="score_max_slider"> </div>
            <div class="col-sm-2"><input type="number" id="score_max_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="score_half_slider">Half Time Score </label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="1" max="15" value="8" id="score_half_slider"> </div>
            <div class="col-sm-2"><input type="number" id="score_half_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="a_o_hold_slider"> Team A Offence Line Turnover Chance </label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="0" max="0.99" value="0.5" step="0.01"  id="a_o_hold_slider"></div>
            <div class="col-sm-2"><input type="number" id="a_o_hold_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="a_d_hold_slider">Team A Defence Line Turnover Chance</label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="0" max="0.99" value="0.5" step="0.01"  id="a_d_hold_slider"></div>
            <div class="col-sm-2"><input type="number" id="a_d_hold_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="b_o_hold_slider">Team B Offence Line Turnover Chance</label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="0" max="0.99" value="0.5" step="0.01"  id="b_o_hold_slider"></div>
            <div class="col-sm-2"><input type="number" id="b_o_hold_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="b_d_hold_slider">Team B Defence Line Turnover Chance</label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="0" max="0.99" value="0.5" step="0.01"  id="b_d_hold_slider"></div>
            <div class="col-sm-2"><input type="number" id="b_d_hold_slider_value"></div>
        </div>
        
        <br>
        
        <div class="row" data-mdb-range-init>
            <div class="col-sm-2"><label class="form-label" for="num_sims_slider">Number of Simulations</label></div>
            <div class="col-sm-8"><input type="range" class="form-range" min="0" max="6" value="5" step="1"  id="num_sims_slider"></div>
            <div class="col-sm-2"><input type="number" id="num_sims_slider_value"></div>
        </div>
        
        <div class="row" ><br><input type="text" id="wins"></div>
        <div class="row" ><br><input type="text" id="team_a_offence_point_chance"></div>
        <div class="row" ><br><input type="text" id="team_b_offence_point_chance"></div>
        <div class="row" ><br><input type="submit" id="submit" value="Submit" class="btn btn-default btn-lg btn-primary"></div>
        <div class="row" ><br><canvas id="scoreChart" width="400" height="200"></canvas></div>
        <div class="row" ></div><p>The score format is "Team A , Team B".</p></div>
		<br>
		<div class="row" ><div id="my_dataviz" style="max-width: 540px;height: 400px;margin: 0px auto"></div></div>
     
    </div>
</div>




<script>

var score_max_slider = document.getElementById("score_max_slider");
var score_half_slider = document.getElementById("score_half_slider");
var a_o_hold_slider = document.getElementById("a_o_hold_slider");
var a_d_hold_slider = document.getElementById("a_d_hold_slider");
var b_o_hold_slider = document.getElementById("b_o_hold_slider");
var b_d_hold_slider = document.getElementById("b_d_hold_slider");
var num_sims_slider = document.getElementById("num_sims_slider");

var init_score_max = document.getElementById("score_max_slider_value").value;
var init_score_half = document.getElementById("score_half_slider_value").value;

const init_assumptions = {
    0: { 0: a_o_hold_slider.value, 1: a_d_hold_slider.value },
    1: { 0: b_o_hold_slider.value, 1: b_d_hold_slider.value },
};

var num_sims_slider = document.getElementById("num_sims_slider_value").value;

function generateScoresDictionary(maxScore) {
  const scores = {};
  for (let i = 0; i < maxScore; i++) {
    scores[[maxScore, i]] = 0 ;    
  }
  for (let i = maxScore - 1; i >= 0; i--) {
    scores[[i, maxScore]] = 0 ;    
  }
  return scores;
}

function sim(assumptions, score_max = 15 , score_half = 8 ) {

  const state = {
    score: [0, 0],
    pullReceive: 0,
    offence: 0,
  };
  var half_not_reached = true ; 
  var turnovers = {0:{0:0,1:0} , 1:{0:0,1:0} }; 
  
  while (Math.max(...state.score) < score_max) {
	
    // Turnover
    if (Math.random() < assumptions[state.offence][state.pullReceive ^ state.offence]) { 
      // console.log("Turnover Offence:", state.offence);  // For debugging (uncomment if needed)
      turnovers[state.offence][state.pullReceive ^ state.offence] += 1 ; 
	  state.offence = 1 - state.offence  ; 
    } else {
      // Score
      state.score[state.offence] += 1;
      if (Math.max(...state.score) == score_half && half_not_reached ) {
        state.pullReceive = 1; //at half make second team on offence
        half_not_reached = false ; 
      }
      else{
        state.pullReceive = 1 - state.offence;  //otherwise switch offence
      }
      
      state.offence = state.pullReceive;
      //console.log("Score:", state.score, "Turnovers:", JSON.stringify(turnovers) );  // For debugging (uncomment if needed)
    }
  }
  outputs = {"score": state.score , "turnovers": turnovers , "combined_turnovers":[turnovers[0][0]+turnovers[0][1] , turnovers[1][0]+turnovers[1][1]]} ; 
  return outputs;
} 

function updateTurnovers( sim_results, turnovers, i, j) {
  const key = sim_results["turnovers"][i][j];
  if (key in turnovers[i][j]) {
    turnovers[i][j][key] += 1;
  } else {
    turnovers[i][j][key] = 1;
  }
  
}


function sims(num_sims, assumptions, score_max, score_half){
  //run the sims and store the summarised results 
  
  scores = generateScoresDictionary(score_max)
  turnovers = {0:{0: {},1: {}} , 1:{0: {},1: {} } };
  combined_turnovers = []
  
  for (let i = 0; i < num_sims; i++) {
    sim_results = sim(assumptions,score_max, score_half) ; 
	//TODO replace with function 
	
	updateTurnovers(sim_results, turnovers, 0, 0) ; 
	updateTurnovers(sim_results, turnovers, 0, 1) ; 
	updateTurnovers(sim_results, turnovers, 1, 0) ; 
	updateTurnovers(sim_results, turnovers, 1, 1) ; 
	
	combined_turnovers.push( { 
        "x": sim_results["combined_turnovers"][0] , 
	    "y": sim_results["combined_turnovers"][1]  
    } ); 

	
    //console.log(JSON.stringify(sim_results["turnovers"]));
	score = sim_results["score"] ;
    scores[score] += 1 ;
	
  }
  //console.log(JSON.stringify(combined_turnovers));  // For debugging (uncomment if needed)
  outputs = {"scores": scores , "turnovers": turnovers , "combined_turnovers": combined_turnovers} ; 
  return(outputs)
}

function updateTextboxValue(id) {
  document.getElementById(id+"_value").value = document.getElementById(id).value ;    
}

function calcPointChance(offence_turnover_chance, defence_turnover_chance) {
  return( (1 - offence_turnover_chance) / (1 - defence_turnover_chance*offence_turnover_chance) )
}


function updateTextboxValueLog(id) {
  document.getElementById(id+"_value").value = Math.pow(10, document.getElementById(id).value );
}

// ************************* LISTENERS ************************* 

// Set up an event listener to call the updateTextboxValue function when the slider value changes
document.getElementById("score_max_slider").addEventListener("input", function() {
  updateTextboxValue("score_max_slider");
});

document.getElementById("score_half_slider").addEventListener("input", function() {
  updateTextboxValue("score_half_slider");
});

document.getElementById("a_o_hold_slider").addEventListener("input", function() {
  updateTextboxValue("a_o_hold_slider");
});

document.getElementById("a_d_hold_slider").addEventListener("input", function() {
  updateTextboxValue("a_d_hold_slider");
});

document.getElementById("b_o_hold_slider").addEventListener("input", function() {
  updateTextboxValue("b_o_hold_slider");
});

document.getElementById("b_d_hold_slider").addEventListener("input", function() {
  updateTextboxValue("b_d_hold_slider");
});

document.getElementById("num_sims_slider").addEventListener("input", function() {
  updateTextboxValueLog("num_sims_slider");
});

document.getElementById("submit").addEventListener("click", function() {

    init_assumptions[0][0] = document.getElementById("a_o_hold_slider_value").value ; 
    init_assumptions[0][1] = document.getElementById("a_d_hold_slider_value").value ; 
    init_assumptions[1][0] = document.getElementById("b_o_hold_slider_value").value ; 
    init_assumptions[1][1] = document.getElementById("b_d_hold_slider_value").value ; 

    init_score_max = document.getElementById("score_max_slider_value").value ; 
    init_score_half = document.getElementById("score_half_slider_value").value ; 
    init_num_sims = document.getElementById("num_sims_slider_value").value ; 
    
	sims_results = sims(init_num_sims,init_assumptions,init_score_max,init_score_half) ; 
    sims_scores = sims_results['scores'] ;
	sims_turnovers = sims_results['turnovers'] ;
	
    var wins = 0 
    //calculate number of wins
    for (var i = 0; i < init_score_max; i++) {
      wins += sims_scores[[init_score_max,i]];
    }

    document.getElementById("wins").value = (wins / init_num_sims) ; 

    document.getElementById("team_a_offence_point_chance").value = calcPointChance(init_assumptions[0][0] , init_assumptions[1][1]) ; 
    document.getElementById("team_b_offence_point_chance").value = calcPointChance(init_assumptions[1][0] , init_assumptions[0][1]) ; 

    var labels = Object.keys(sims_scores);
    // Extract labels and data values from the data object
    var values = Object.values(sims_scores);


	var chartOptions = {
            scales: {x:{ticks: {color: 'white' }},
                     y: {ticks: {color: 'white' },// Font color for y-axis labels} 
                        beginAtZero: true
                    }},
            plugins: {
                legend: {labels: {color: 'white'}}, // Font color for legend labels
                tooltip: {
                    bodyFontColor: 'white', // Font color for tooltip text
                    titleFontColor: 'white' // Font color for tooltip title
                }}} ; 
				 
    // Create a new chart instance
    var ctx = document.getElementById('scoreChart').getContext('2d');

    let chartStatus = Chart.getChart("scoreChart"); // <canvas> id
    if (chartStatus != undefined) {
        chartStatus.destroy();
    }

    var scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Count',
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
        }]},
        options: chartOptions 
    });
  

    // set the dimensions and margins of the graph
    const margin = {top: 10, right: 30, bottom: 30, left: 40},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    
    d3.select("#my_dataviz").selectAll('svg').remove();
    // append the svg object to the body of the page
    const svg = d3.select("#my_dataviz")
    .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
    .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);


	// read data
	var data = sims_results['combined_turnovers'] ;

    var xs = data.map(function(item) {return item.x;});
    var ys = data.map(function(item) {return item.y;});

  // Add X axis
  const x = d3.scaleLinear()
    .domain([0, xs.reduce((a, b) => Math.max(a, b), -Infinity) + 1 ])
    .range([ margin.left, width - margin.right ]);
  svg.append("g")
    .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(x));

  // Add Y axis
  const y = d3.scaleLinear()
    .domain([0, ys.reduce((a, b) => Math.max(a, b), -Infinity) + 1])
    .range([ height - margin.bottom, margin.top ]);
  svg.append("g")
    .call(d3.axisLeft(y));


  // compute the density data
  const densityData = d3.contourDensity()
    .x(function(d) { return x(d.x); })
    .y(function(d) { return y(d.y); })
    .bandwidth(10) 
    (data)

    const maxDensity = Math.max.apply(this, densityData.map(d => d.value));    

  // Prepare a color palette
  const color = d3.scaleLinear()
      .domain([0, maxDensity/3]) // Points per square pixel.
      .range(["#212529", "#b35555"])


  // show the shape!
  svg.insert("g", "g")
    .selectAll("path")
    .data(densityData)
    .enter().append("path")
      .attr("d", d3.geoPath())
      .attr("fill", function(d) { return color(d.value); })

    
});



// Call the updateTextboxValue function initially to display the initial slider value
updateTextboxValue("score_max_slider");
updateTextboxValue("score_half_slider");
updateTextboxValue("a_o_hold_slider");
updateTextboxValue("a_d_hold_slider");
updateTextboxValue("b_o_hold_slider");
updateTextboxValue("b_d_hold_slider");
updateTextboxValueLog("num_sims_slider");
</script>

<script>
    $(document).ready(function(){
      // Add smooth scrolling to all links in navbar + footer link
      $(".navbar a, footer a[href='#myPage']").on('click', function(event) {
        // Make sure this.hash has a value before overriding default behavior
        if (this.hash !== "") {
          // Prevent default anchor click behavior
          event.preventDefault();
    
          // Store hash
          var hash = this.hash;
    
          // Using jQuery's animate() method to add smooth page scroll
          // The optional number (900) specifies the number of milliseconds it takes to scroll to the specified area
          $('html, body').animate({
            scrollTop: $(hash).offset().top
          }, 100, function(){
       
            // Add hash (#) to URL when done scrolling (default click behavior)
            window.location.hash = hash;
          });
        } // End if
      });
      
      $(window).scroll(function() {
        $(".slideanim").each(function(){
          var pos = $(this).offset().top;
    
          var winTop = $(window).scrollTop();
            if (pos < winTop + 600) {
              $(this).addClass("slide");
            }
        });
      });
    })
</script>

</body>
</html>